---
title: "NWSL Championship 2015 Stats"
output: html_document
runtime: shiny
---

What this is
---

This is an R Markdown document that 

The purpose of this document is to explore how effective the stats I measured are for determining the effectiveness of the Portland Thorns both as individual players and as a team. I will also explore how these stats, which are different from the Template 1 stats I used for the Thorns-Red Stars match from April 25, 2015, compare as a what-should-be more effective set of metrics.

Compared to the Red Stars match, this should better measure location of events, defensive events, types of passes, and take-ons.

Perhaps more importantly, this R markdown document will (hopefully) only need the raw match stats. I'll hopefully be able to read these stats into this R Markdown document without having to create a new csv file with thousands of columns for every conceivable combination of events. This should greatly improve the way these stats are stored and transformed for analysis, and perhaps, since the chronological aspect of the events will be preserved, this will even enhance how I can measure match stats and situational stats.

Here we go. This R Markdown document only tracks the first 15 minutes of the match.

Testing stuff
---
This section, like all following sections, will be broken up into Basic Metrics and Advanced Metrics.
These are all the pass events for Rachel Van Hollebeke, just to test things out.

```{r, echo=FALSE, comment=NA, include=FALSE}
library(plyr)
library(dplyr)

## FOR SEATTLE-only
## dnotused <- d[d[,"poss.team"] == "SRFC" & d[,"poss.player"] != " ",]

## KANSAS CITY-only
## dnotused <- d[d[,"poss.team"] == "FCKC" & d[,"poss.player"] != " ",]

## Change relevant columns to character type
d$poss.position <- as.character(d$poss.position)
d$poss.team <- as.character(d$poss.team)
d$poss.player <- as.character(d$poss.player)
d$poss.player.event <- as.character(d$poss.player.event)
d$poss.location <- as.character(d$poss.location)
d$poss.destination <- as.character(d$poss.destination)
d$ball.type <- as.character(d$ball.type)
d$poss.notes <- as.character(d$poss.notes)
d$def.position <- as.character(d$def.position)
d$def.team <- as.character(d$def.team)
d$def.player <- as.character(d$def.player)
d$def.event <- as.character(d$def.event)
d$def.location <- as.character(d$def.location)
d$gk.ball.result <- as.character(d$gk.ball.result)
d$gk.s.o.g.attempt <- as.character(d$gk.s.o.g.attempt)
d$def.player.disciplinary <- as.character(d$def.player.disciplinary)
d$def.notes <- as.character(d$def.notes)

```

Attacking
---

* Shots
* Assists & Key Passes
* Big Chances
    * *One-on-one chances that should result in goals*
* Shots Under Pressure
* Shot Location
* Crosses
* Through Balls

```{r shots, echo=FALSE, comment=NA}
## Creates table for players pased on types of shots.
t <- createTable(c("shots", "accuracy", "shots.scored", "shots.stopped.by.gk", "shots.stopped.by.def", "shots.blocked.by.def", "shots.missed") ,"poss.player.event", d)

## Add column adding all shot attempts
t$shots <- t$shots.scored + t$shots.stopped.by.gk + t$shots.stopped.by.def + t$shots.blocked.by.def + t$shots.missed

## Add column for accuracy
t$accuracy <- (t$shots.scored + t$shots.stopped.by.gk + t$shots.stopped.by.def)/(t$shots.scored + t$shots.stopped.by.gk + t$shots.stopped.by.def + t$shots.missed)

##Sort by "shots" and "accuracy"
t <- t[order(-t$shots, -t$accuracy),]

## Change names to be more readable
names(t) <- c("Shots","Accuracy","Scored","GK Stop", "DEF Stop", "Blocked", "Missed")

shots <-t
shots <- cbind("Player" = rownames(shots), shots)

```

```{r key_passes, echo=FALSE, comment=NA}
t <- createTable(c("key.passes" ,"assists", "second.assists", "unscored.key.passes"), "poss.notes", d)

## Add column for all key passes
t$key.passes <- t$assists + t$second.assists + t$unscored.key.passes

##Sort by "assists" and "second.assists"
t <- t[order(-t$assists, -t$second.assists),]

## Change names to be more readable
names(t) <- c("Total Key Passes","Assists","Second Assists", "Unscored Key Passes")

keypasses <- t
keypasses <- cbind(rownames(keypasses), keypasses)

```

```{r big_chances, echo=FALSE, comment=NA}
t <- createTable(c("big.chances", "big.chances.scored", "big.chances.shot.on.goal", "big.chances.shot.missed",  "big.chances.dispossessed"),"poss.notes", d)

t$big.chances <- t$big.chances.scored + t$big.chances.dispossessed + t$big.chances.shot.on.goal + t$big.chances.shot.missed

## Sort by "big.chances" and "big.chances.scored"
t <- t[order(-t$big.chances, -t$big.chances.scored),]

names(t) <- c("Big Chances","Scored", "SOG", "Missed", "Dispossessed")

bigchances <- t
bigchances <- cbind("Player" = rownames(bigchances), bigchances)

```

```{r shots_under_pressure, echo=FALSE, comment=NA}
t <- createCleanDataFrame(c("shots", "accuracy", "shots.scored", "shots.stopped.by.gk", "shots.stopped.by.def", "shots.blocked.by.def", "shots.missed") ,"poss.player.event", d)
## Adds column for whether shot is "under.pressure" or "not.under.pressure"
t2 <- addColumnForQualifier("pressure", "pressured.opp", "def.event", d, t)

## Create table with a column for shots under and not under pressure
t3 <- createTable(c("total", "pct","yes", "no"), "pressure", t2)
## Add "total" and "pct" values
t3$total <- t3$yes + t3$no
t3$pct <- t3$yes/t3$total
# rename and print
t3 <- t3[,2:4]
names(t3) <- c("Pct of All Shots", "Under Press.", "Not Under Press.")
shotsunderpressure <- t3
shotsunderpressure <- cbind("Player" = rownames(shotsunderpressure), shotsunderpressure)

```

```{r shot_location, echo=FALSE, comment=NA}
t <- createCleanDataFrame(c("shots", "accuracy", "shots.scored", "shots.stopped.by.gk", "shots.stopped.by.def", "shots.blocked.by.def", "shots.missed") ,"poss.player.event", d)

## Creates table for shot.location
t2 <- createTable(c("OPP.6.YD", "OPP.18.YD","OPP.3RD.L","OPP.3RD.C","OPP.3RD.R","beyond","OPP.MID.3RD.L","OPP.MID.3RD.C",
                    "OPP.MID.3RD.R", "DEF.MID.3RD.L","DEF.MID.3RD.C","DEF.MID.3RD.R","DEF.3RD.L","DEF.3RD.C",
                    "DEF.3RD.R","DEF.18.YD","DEF.6.YD"), "poss.location", t)
## Add everything beyond the attacking 3rd and put it in the "Beyond" column
t2$beyond <- rowSums(t2[,7:17])
## Get rid of all columns after the "Beyond" column to save space
t2 <- t2[,1:6]
shotlocation <- t2
shotlocation <- cbind("Player" = rownames(shotlocation), shotlocation)

## Might use this later
## d6$poss.player.location <- factor(as.character(d6$poss.player.location), levels = c("in.attacking.third.left", "in.attacking.third.center", "in.attacking.third.right", "in.middle.third.left", "in.middle.third.center", "in.middle.third.right", "in.defensive.third.left", "in.defensive.third.center", "in.defensive.third.right", "in.opp.18.yd.box", "in.opp.6.yd.box", "in.own.18.yd.box", "in.own.6.yd.bx"))
```

```{r crosses, echo=FALSE, comment=NA}
t <- createCleanDataFrame(c("corner.crosses", "deep.crosses"), "ball.type", d)

## Create table with columns for completed, blocked, and missed crosses
t2 <- createTable(c("completed", "pct", "attempts", "passes.f.c", "passes.f.b", "passes.f.m", 
                    "passes.s.c", "passes.s.b", "passes.s.m"), "poss.player.event", t)
## Calculate empty columns
t2$completed <- t2$passes.f.c + t2$passes.s.c
t2$attempts <- rowSums(t2[,4:9])
t2$pct <- t2$completed/t2$attempts
t2 <- t2[,1:3]

## Create table with columns for corner and deep crosses
t3 <- createTable(c("corner.crosses", "deep.crosses"), "ball.type", t)

# Merge the two sets of columns
t4 <- cbind(t2, t3)
t4 <- t4[order(-t4$completed, -t4$pct, t4$attempts),]

names(t4) <- c("Completed", "Pct", "Attempts", "Corner", "Long")
crosses <- t4
crosses <- cbind("Player" = rownames(crosses), crosses)

```

```{r through_balls, echo=FALSE, comment=NA}
t <- createCleanDataFrame(c("through.balls"), "ball.type", d)

## Create table
t2 <- createTable(c("completed", "pct", "attempts", "passes.f.c", "passes.f.b", "passes.f.m"), "poss.player.event", t)
## Calculate empty columns
t2$completed <- t2$passes.f.c
t2$attempts <- rowSums(t2[,4:6])
t2$pct <- t2$completed/t2$attempts
t2 <- t2[,1:3]
t2 <- t2[order(-t2$completed, -t2$pct, t2$attempts),]

names(t2) <- c("Completed", "Pct", "Attempts")

throughballs <- t2
throughballs <- cbind("Player" = rownames(throughballs), throughballs)

selectInput("shotsevent", "Select an Attacking Stat:", c("Shots", "Key Passes", "Big Chances", "Shots Under Pressure", "Shot Location", "Crosses", "Through Balls"))

shotsInput <- reactive({
  selection <- switch(input$shotsevent, "Shots" = shots, "Key Passes" = keypasses, "Big Chances" = 
                        bigchances, "Shots Under Pressure" = shotsunderpressure, 
                      "Shot Location" = shotlocation, "Crosses" = crosses, 
                      "Through Balls" = throughballs)
})

renderDataTable(shotsInput(), options = list(searching = FALSE, digits = 2))

```

Passing
---

* Overall Passing
* Pass Attempts by Location
    * Attacking Third
    * Middle Third
    * Defensive Third
* Passing Under Pressure
* Passes by Length

```{r overall_passing, echo=FALSE, comment=NA}
t <- createCleanDataFrame(c("passes.f.c", "passes.f.b", "passes.f.m", 
                    "passes.s.c", "passes.s.b", "passes.s.m", "passes.b.c", 
                    "passes.b.b", "passes.b.m"), "poss.player.event", d)

t2 <- createTable(c("completed", "pct", "attempts" , "passes.f.c", "passes.f.b", "passes.f.m", 
                    "passes.s.c", "passes.s.b", "passes.s.m", "passes.b.c", 
                    "passes.b.b", "passes.b.m"), "poss.player.event", t)
## Calculate blank columns & then get rid of excess
t2$attempts <- rowSums(t2[,c(4:12)])
t2$completed <- rowSums(t2[,c(4,7,10)])
t2$pct <- t2$completed/t2$attempts
t2 <- t2[,1:3]

# Order
t2 <- t2[order(-t2$completed, -t2$pct),]

names(t2) <- c("Completed", "Pct", "Attempts")
allpasses <- t2
allpasses <- cbind("Player" = rownames(allpasses), allpasses)

```

```{r pass_attempt_location, echo=FALSE, comment=NA}
t2 <- createTable(c("Total","Attacking Third", "Middle Third","Defensive Third","Left Flank",
                    "Right Flank","OPP.6.YD","OPP.18.YD","OPP.3RD.L","OPP.3RD.C","OPP.3RD.R",
                    "OPP.MID.3RD.L","OPP.MID.3RD.C","OPP.MID.3RD.R","DEF.MID.3RD.L","DEF.MID.3RD.C", 
                    "DEF.MID.3RD.R", "DEF.3RD.L","DEF.3RD.C", "DEF.3RD.R","DEF.18.YD","DEF.6.YD"), 
                  "poss.location", t)
## Calculate total
t2[,"Total"] <- rowSums(t2[,7:16])
t2[,"Attacking.Third"] <- rowSums(t2[,c("OPP.6.YD","OPP.18.YD","OPP.3RD.L","OPP.3RD.C","OPP.3RD.R")])
t2[,"Middle.Third"] <- rowSums(t2[,c("OPP.MID.3RD.L","OPP.MID.3RD.C","OPP.MID.3RD.R","DEF.MID.3RD.L","DEF.MID.3RD.C", "DEF.MID.3RD.R")])
t2[,"Defensive.Third"] <- rowSums(t2[,c("DEF.3RD.L","DEF.3RD.C", "DEF.3RD.R","DEF.18.YD","DEF.6.YD")])
t2[,"Left.Flank"] <- rowSums(t2[,c(9,12,15,18)])
t2[,"Right.Flank"] <- rowSums(t2[,c(11,14,17,20)])
 
passlocation <- t2
passlocation <- cbind("Player" = rownames(passlocation), passlocation)

```

```{r attack_3rd_passing, echo=FALSE, comment=NA}
t2 <- createCleanDataFrame(c("OPP.6.YD","OPP.18.YD","OPP.3RD.L","OPP.3RD.C","OPP.3RD.R"), "poss.destination", t)

t3 <- createTable(c("Completed", "Pct", "Attempts", "passes.f.c", "passes.f.b", "passes.f.m", 
                    "passes.s.c", "passes.s.b", "passes.s.m", "passes.b.c", 
                    "passes.b.b", "passes.b.m"), "poss.player.event", t2)
## Fill in blank columns and sort
t3[,"Completed"] <- rowSums(t3[,c(4,7,10)])
t3[,"Attempts"] <- rowSums(t3[,4:12])
t3[,"Pct"] <- t3[,"Completed"]/t3[,"Attempts"]
t3 <- t3[,1:3]

t3 <- t3[order(-t3[,"Completed"], -t3[,"Pct"]),]
attack3rdpasses <- t3
attack3rdpasses <- cbind("Player" = rownames(attack3rdpasses), attack3rdpasses)
```

```{r middle_3rd_passing, echo=FALSE, comment=NA}
t2 <- createCleanDataFrame(c("OPP.MID.3RD.L","OPP.MID.3RD.C","OPP.MID.3RD.R","DEF.MID.3RD.L","DEF.MID.3RD.C", "DEF.MID.3RD.R"), "poss.destination", t)

t3 <- createTable(c("Completed", "Pct", "Attempts", "passes.f.c", "passes.f.b", "passes.f.m", 
                    "passes.s.c", "passes.s.b", "passes.s.m", "passes.b.c", 
                    "passes.b.b", "passes.b.m"), "poss.player.event", t2)
## Fill in blank columns and sort
t3[,"Completed"] <- rowSums(t3[,c(4,7,10)])
t3[,"Attempts"] <- rowSums(t3[,4:12])
t3[,"Pct"] <- t3[,"Completed"]/t3[,"Attempts"]
t3 <- t3[,1:3]

t3 <- t3[order(-t3[,"Completed"], -t3[,"Pct"]),]
mid3rdpasses <- t3
mid3rdpasses <- cbind("Player" = rownames(mid3rdpasses), mid3rdpasses)

```

```{r defensive_3rd_passing, echo=FALSE, comment=NA}
t2 <- createCleanDataFrame(c("DEF.3RD.L","DEF.3RD.C", "DEF.3RD.R","DEF.18.YD","DEF.6.YD"), "poss.destination", t)

t3 <- createTable(c("Completed", "Pct", "Attempts", "passes.f.c", "passes.f.b", "passes.f.m", 
                    "passes.s.c", "passes.s.b", "passes.s.m", "passes.b.c", 
                    "passes.b.b", "passes.b.m"), "poss.player.event", t2)
## Fill in blank columns and sort
t3[,"Completed"] <- rowSums(t3[,c(4,7,10)])
t3[,"Attempts"] <- rowSums(t3[,4:12])
t3[,"Pct"] <- t3[,"Completed"]/t3[,"Attempts"]
t3 <- t3[,1:3]

t3 <- t3[order(-t3[,"Completed"], -t3[,"Pct"]),]
def3rdpasses <- t3
def3rdpasses <- cbind("Player" = rownames(def3rdpasses), def3rdpasses)
```

```{r passing_under_pressire, echo=FALSE, comment=NA}
t2 <- addColumnForQualifier("pressure", "pressured.opp", "def.event", d, t)

## Include only passing attempts under pressure
t3 <- t2[t2[,"pressure"] == "yes",]
## Create table
t3 <- createTable(c("Completed", "Comp Pct","Attempts", "passes.f.c", "passes.f.b", "passes.f.m", 
                    "passes.s.c", "passes.s.b", "passes.s.m", "passes.b.c", 
                    "passes.b.b", "passes.b.m"), "poss.player.event", t3)
## Fill in blank columns and sort
t3[,"Completed"] <- rowSums(t3[,c(4,7,10)])
t3[,"Attempts"] <- rowSums(t3[,4:12])
t3[,"Comp.Pct"] <- t3[,"Completed"]/t3[,"Attempts"]
t3 <- t3[,1:3]

## Create a table comparing how many passes were under pressure
t4 <- createTable(c("Pct of Passes", "yes", "no"), "pressure", t2)
## Add "total" and "pct" values
t4[,"Pct.of.Passes"] <- t4$yes/(t4$yes + t4$no)
## Exclude rows with 0% passes under pressure
t4 <- t4[t4[,"Pct.of.Passes"] != 0,]

## Merge columns
t5 <- cbind(t4,t3)
t5 <- t5[order(-t5[,"Completed"], -t5[,"Comp.Pct"], -t5[,"Pct.of.Passes"]),]
t5 <- t5[,c("Pct.of.Passes", "Completed", "Comp.Pct","Attempts")]

pressuredpasses <- t5
pressuredpasses <- cbind("Player" = rownames(pressuredpasses), pressuredpasses)
#table(t5)
#
#renderTable({
#  head(t5)
#})

selectInput("passingevent", "Select a Passing Stat:", c("All Pass Attempts", 
                                                    "Passes by Location", 
                                                    "Passes in Attacking 3rd", 
                                                    "Passes in Middle 3rd", 
                                                    "Passes in Defensive 3rd", 
                                                    "Passing Under Pressure"))

passingInput <- reactive({
  selection <- switch(input$passingevent, "All Pass Attempts" = allpasses, 
                      "Passes by Location" = passlocation, 
                      "Passes in Attacking 3rd" = attack3rdpasses, 
                      "Passes in Middle 3rd" = mid3rdpasses, 
                      "Passes in Defensive 3rd" = def3rdpasses, 
                      "Passing Under Pressure" = pressuredpasses)
})

renderDataTable(passingInput(), options = list(searching = FALSE, digits = 2))

```

Possession
---
* Take Ons
* Aerial Duels

```{r take_ons, echo=FALSE, comment=NA}
t <- createCleanDataFrame(c("take.on.won", "take.on.lost", "dispossessed"),"poss.player.event", d)

t2 <- createTable(c("take.on.won", "Take On Success" ,"Take Ons", "take.on.lost", "dispossessed"), "poss.player.event", t)
## Fill in blank columns & rename
t2[,"Take.Ons"] <- t2[,"take.on.won"] + t2[,"take.on.lost"]
t2[,"Take.On.Success"] <- t2[,"take.on.won"]/t2[,"Take.Ons"]
t2 <- t2[order(-t2[,"take.on.won"], -t2[,"Take.On.Success"]),]
names(t2) <- c("Won", "Pct", "Attempts", "Lost", "Dispossessed")

takeons <- cbind("Player" = rownames(t2), t2)

```

```{r aerial_duels, echo=FALSE, comment=NA}
t <- createDataFrame(c("aerial.challenges.won", "aerial.challenges.lost"), "poss.player.event", d)

t2 <- t[,c("event", "time", "poss.position", "poss.team", "poss.player", "poss.player.event", "poss.location")]
names(t2) <- c("event", "time", "position", "team", "poss.player", "player.event", "location")
t3 <- t[,c("event", "time","def.position", "def.team", "def.player", "def.event", "def.location")]
names(t3) <- c("event", "time", "position", "team", "poss.player", "player.event", "location")
t4 <- rbind(t2,t3)

t5 <- createTable(c("aerial.challenges.won", "Success Pct", "Aerial Duels", "aerial.challenges.lost"), "player.event", t4)

## Fill in blank columns, sort, & rename
t5[,"Aerial.Duels"] <- t5[,"aerial.challenges.won"] + t5[,"aerial.challenges.lost"]
t5[,"Success.Pct"] <- t5[,"aerial.challenges.won"]/t5[,"Aerial.Duels"]
t5 <- t5[order(-t5[,"aerial.challenges.won"], -t5[,"Success.Pct"], t5[,"Aerial.Duels"]),]
t5 <- t5[,1:3]
names(t5) <- c("Won", "Pct", "Attempts")

aerialduels <- cbind("Player" = rownames(t5), t5)

selectInput("possessionevent", "Select a Possession Stat:", c("Take Ons", "Aerial Duels"))

possessionInput <- reactive({
  selection <- switch(input$possessionevent, "Take Ons" = takeons, 
                      "Aerial Duels" = aerialduels)
})

renderDataTable(possessionInput(), options = list(searching = FALSE, digits = 2))

```

Defending
---
* Tackles & Pressure
* Interceptions
* Recoveries
* Clearances, Ball Shields, & Blocks
* Balls Disrupted per 90 Minutes

###Tackles & Pressure
```{r tackles_pressure, echo=FALSE,comment=NA}
t <- createDataFrame(c("dispossessed.ball.shielded", "dispossessed.steal", "dispossessed.lost.touch", 
                       "tackles.ball.away", "tackles.wins.ball", "dribbled.tackles.missed", 
                       "dribbled.out.run","dribbled.turned","pressured.opp"), "def.event", d)

t <- t[,c("event","time","def.position","def.team","def.player","def.event","def.location","def.player.disciplinary","def.notes")]
names(t) <- c("event", "time", "position" ,"team", "poss.player", "player.event", "location", 
              "def.player.disciplinary", "def.notes")

t2 <- createTable(c("Tackles", "Dribbles Allowed", "pressured.opp", "Dispossessed Opp", 
                    "dispossessed.ball.shielded", "dispossessed.steal",
                    "dispossessed.lost.touch", "tackles.ball.away", "tackles.wins.ball",
                    "dribbled.tackles.missed", "dribbled.out.run","dribbled.turned"), "player.event", t)

## Fill in blank columns, get rid of excess columns, and rename
t2$Tackles <- t2$tackles.ball.away + t2$tackles.wins.ball
t2$Dribbles.Allowed <- t2$dribbled.tackles.missed + t2$dribbled.out.run + t2$dribbled.turned
t2$Dispossessed.Opp <- t2$dispossessed.ball.shielded + t2$dispossessed.steal + t2$dispossessed.lost.touch
t2 <- t2[,1:5]
t2 <- t2[order(-t2$Tackles, t2[,"Dribbles.Allowed"]),]
names(t2) <- c("Tackles", "Dribbles Allowed", "Pressed Opp", "Dispossessed Opp", "Balls Shielded")

tacklespressure <- cbind("Player" = rownames(t2), t2)
```

###Interceptions
```{r interceptions, echo=FALSE, comment=NA}
t <- createCleanDataFrame(c("interceptions", "def.recoveries", "poss.recoveries"), "poss.player.event", d)

t2 <- t[t[,"poss.player.event"] == "interceptions",]
t2 <- createTable(c("interceptions", "Def 3rd", "Mid 3rd", "Opp 3rd", "OPP.6.YD","OPP.18.YD","OPP.3RD.L","OPP.3RD.C","OPP.3RD.R",
                    "OPP.MID.3RD.L","OPP.MID.3RD.C","OPP.MID.3RD.R","DEF.MID.3RD.L","DEF.MID.3RD.C", 
                    "DEF.MID.3RD.R", "DEF.3RD.L","DEF.3RD.C", "DEF.3RD.R","DEF.18.YD","DEF.6.YD"), "poss.location", t2)
## Fill in blanks
t2$interceptions <- rowSums(t2[,4:20])
t2[,"Def.3rd"] <- rowSums(t2[,c("DEF.3RD.L","DEF.3RD.C", "DEF.3RD.R","DEF.18.YD","DEF.6.YD")])
t2[,"Mid.3rd"] <- rowSums(t2[,c("OPP.MID.3RD.L","OPP.MID.3RD.C","OPP.MID.3RD.R","DEF.MID.3RD.L",
                                "DEF.MID.3RD.C", "DEF.MID.3RD.R")])
t2[,"Opp.3rd"] <- rowSums(t2[,c("OPP.6.YD","OPP.18.YD","OPP.3RD.L","OPP.3RD.C","OPP.3RD.R")])
t2 <- t2[,1:4]
t2 <- t2[order(-t2$interceptions, -t2[,"Def.3rd"]),]
names(t2) <- c("Total", "In Def 3rd", "In Mid 3rd", "In Opp 3rd")

interceptions <- cbind("Player" = rownames(t2), t2)
```

###Recoveries
```{r recoveries, echo=FALSE, comment=NA}
t2 <- t[t[,"poss.player.event"] != "interceptions",]
t2 <- createTable(c("recoveries", "Def 3rd", "Mid 3rd", "Opp 3rd", "OPP.6.YD","OPP.18.YD","OPP.3RD.L","OPP.3RD.C","OPP.3RD.R",
                    "OPP.MID.3RD.L","OPP.MID.3RD.C","OPP.MID.3RD.R","DEF.MID.3RD.L","DEF.MID.3RD.C", 
                    "DEF.MID.3RD.R", "DEF.3RD.L","DEF.3RD.C", "DEF.3RD.R","DEF.18.YD","DEF.6.YD"), "poss.location", t2)
## Fill in blanks
t2$recoveries <- rowSums(t2[,4:20])
t2[,"Def.3rd"] <- rowSums(t2[,c("DEF.3RD.L","DEF.3RD.C", "DEF.3RD.R","DEF.18.YD","DEF.6.YD")])
t2[,"Mid.3rd"] <- rowSums(t2[,c("OPP.MID.3RD.L","OPP.MID.3RD.C","OPP.MID.3RD.R","DEF.MID.3RD.L",
                                "DEF.MID.3RD.C", "DEF.MID.3RD.R")])
t2[,"Opp.3rd"] <- rowSums(t2[,c("OPP.6.YD","OPP.18.YD","OPP.3RD.L","OPP.3RD.C","OPP.3RD.R")])
t2 <- t2[,1:4]
t2 <- t2[order(-t2$recoveries),]
names(t2) <- c("Total", "In Def 3rd", "In Mid 3rd", "In Opp 3rd")

recoveries <- cbind("Player" = rownames(t2), t2)
```

###Clearances, Ball Shields, & Blocks
```{r clearances_shields_blocks, echo=FALSE, comment=NA}
t <- createDataFrame(c("clearances", "balls.shielded", "passes.blocked", "shots.blocked"), "def.event", d)
t <- t[,c("event","time", "def.position","def.team","def.player","def.event","def.location", "def.player.disciplinary","def.notes")]

names(t) <- c("event", "time", "position","team", "poss.player", "player.event", "location", 
              "def.player.disciplinary", "def.notes")

t2 <- createTable(c("passes.blocked","shots.blocked", "clearances", "balls.shielded"), "player.event", t)
t2 <- t2[order(-t2$passes.blocked, -t2$shots.blocked),]
names(t2) <- c("Passes Blocked", "Shots Blocked","Clearances", "Balls Shielded")

clearances <- cbind("Player" = rownames(t2), t2)

selectInput("defendingevent", "Select a Possession Stat:", c("Tackles", "Interceptions", "Recoveries", "Clearances/Shields/Blocks"))

defendingInput <- reactive({
  selection <- switch(input$defendingevent, "Tackles" = tacklespressure, 
                      "Interceptions" = interceptions,
                      "Recoveries" = recoveries,
                      "Clearances/Shields/Blocks" = clearances)
})

renderDataTable(defendingInput(), options = list(searching = FALSE, digits = 2))
```


Goalkeeping
---
* Shots Faced
* High Balls
* Smothers
* Distribution

###Shots Faced
```{r gk_shots_faced, echo=FALSE, comment=NA}
t <- createDataFrame(c("gk.shot.on.goal.faced"), "def.event", d)
t <- t[!is.na(t[,"gk.ball.result"]),c(5:6,14:21)]
t <- addColumnForQualifier("save.attempt", "save","gk.s.o.g.attempt", d, t)
t <- addColumnForQualifier("goal.conceded", "goal.conceded", "gk.ball.result", d, t)
names(t) <- c("event", "time", "poss.notes", "position", "team", "poss.player", "def.event", "def.location", 
              "gk.ball.result", "gk.s.o.g.attempt", "save.attempt", "goal.conceded")

## Create table for saves, fill in blank columns, cut down excess columns
t2 <- createTable(c("saves", "save.attempts", "yes", "no"), "save.attempt", t)
t2$save.attempts <- t2$yes
t2 <- t2[,c("saves", "save.attempts")]

## Create table for goals conceded, fill in blank columns, cut down excess columns
t3 <- createTable(c("goals.conceded", "yes", "no"), "goal.conceded", t)
t3$goals.conceded <- t3$yes

## Merge tables
t4 <- cbind(t2, t3)
t4$saves <- t4$save.attempts - t4$goals.conceded
t4 <- t4[,1:3]

shots.faced <- cbind("Player" = rownames(t4), t4)

```


###High Balls
```{r gk_high_balls_faced, echo=FALSE, comment=NA}
t <- createDataFrame(c("gk.open.play.high.balls.faced","gk.set.play.high.balls.faced"), "def.event", d)

## Add column for whether an event is a cross
t <- addColumnForQualifier("cross", "cross", "ball.type", d, t)

## Add column for whether an event is a corner kick
t <- addColumnForQualifier("corner.kick", "corner.kick", "ball.type", d, t)

## Add column for whether an event is a free kick
t <- addColumnForQualifier("free.kick", "free.kick", "ball.type", d, t)

## Add column for whether an event is a high ball from open play
t <- addColumnForQualifier("open.play", "open.play", "ball.type", d, t)

## Add column for how many high balls were faced
t <- addColumnForQualifier("high.balls.faced", "high.balls", "def.event", d, t)

## Add columns for how high balls were won
t <- addColumnForQualifier("caught", "caught", "gk.ball.result", d, t)
t <- addColumnForQualifier("punched.away", "punched.to.safety", "gk.ball.result", d, t)

## Only goalkeepers
t <- t[grep("gk", t[,"def.event"]),]
t$poss.player <- t$def.player

t2 <- cbind(createTable(c("yes", "no", "won"), "high.balls.faced", t),
            createTable(c("yes", "no"), "caught", t),
            createTable(c("yes", "no"), "punched.away", t),
            createTable(c("yes", "no"), "cross", t), 
            createTable(c("yes", "no"), "corner.kick", t), 
            createTable(c("yes", "no"), "free.kick", t))

t2 <- t2[,c(1,3,4,6,8,10,12)]
t2$won <- rowSums(t2[,3:4])
names(t2) <- c("Faced", "Won", "Caught", "Punched Away", "Crosses", "Corners", "Free Kicks")

high.balls.faced <- cbind("Player" = rownames(t2), t2)

```

###Smothers
``` {r smothers, echo=FALSE, comment=NA}
t <- createDataFrame("smother", "def.event", d)
```

###Distribution
A lot of kicks and throws from the goalkeepers were cut off by the broadcast, which often cut into play and prevented me from seeing what the goalkeeper did with the ball after winning it. Those instances are not counted in this table.
```{r distribution, echo=FALSE, comment=NA}
t <- createDataFrame(c("free.kick.pass", "goal.kick", "gk.short.throws", "gk.long.throws", "gk.drop.kick"), "ball.type", d)

t <- t[t[,"poss.position"] == "GK",]

t2 <- createTable(c("completed", "pct", "attempts" , "passes.f.c", "passes.f.b", "passes.f.m", 
                    "passes.s.c", "passes.s.b", "passes.s.m", "passes.b.c", 
                    "passes.b.b", "passes.b.m"), "poss.player.event", t)
## Calculate blank columns & then get rid of excess
t2$attempts <- rowSums(t2[,c(4:12)])
t2$completed <- rowSums(t2[,c(4,7,10)])
t2$pct <- t2$completed/t2$attempts
t2 <- t2[,1:3]

# Order
t2 <- t2[order(-t2$completed, -t2$pct),]

names(t2) <- c("Completed", "Pct", "Attempts")
t2 <- t2[,c("Pct", "Attempts")]

distribution <- cbind("Player" = rownames(t2), t2)

selectInput("goalieevent", "Select a Possession Stat:", c("Shots Faced", 
                                                          "High Balls Faced", 
                                                          "Distribution"))

goalieInput <- reactive({
  selection <- switch(input$goalieevent, "Shots Faced" = shots.faced, 
                      "High Balls Faced" = high.balls.faced,
                      "Distribution" = distribution)
})

renderDataTable(goalieInput(), options = list(searching = FALSE, digits = 2))

```